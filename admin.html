<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Training Admin</title>
<meta name="color-scheme" content="dark light">
<style>
:root{
  --bg:#0b1020; --bg2:#0a132a; --card:#131a2a; --muted:#92a0b8; --fg:#e9edf5;
  --input:#0e1525; --border:rgba(255,255,255,.08); --accentA:#22d3ee; --accentB:#3b82f6;
}
:root[data-theme="light"]{ --bg:#f6f7fb; --bg2:#eef2f8; --card:#ffffff; --fg:#0f172a; --input:#f3f4f6; --border:rgba(15,23,42,.12); --muted:#64748b; }
*{box-sizing:border-box} body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);min-height:100vh;}
header{padding:14px 18px;border-bottom:1px solid var(--border)}
.hgrid{max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
.left{justify-self:start}.center{justify-self:center}.right{justify-self:end}
.brand{font-weight:800;letter-spacing:.2px}
.btnLink{background:var(--input);color:var(--fg);border:1px solid var(--border);font-weight:800;padding:8px 14px;border-radius:12px;text-decoration:none}
.toggle{border:1px solid var(--border);background:var(--input);padding:6px 10px;border-radius:999px;cursor:pointer}
.btn{background:linear-gradient(135deg,var(--accentA),var(--accentB));border:none;color:#06111d;font-weight:800;padding:8px 14px;border-radius:12px;cursor:pointer}
.btn.secondary{background:var(--input);color:var(--fg);border:1px solid var(--border)}
main{max-width:1200px;margin:28px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h2{margin:0 0 12px 0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input{border-radius:10px;border:1px solid var(--border);background:var(--input);color:var(--fg);padding:10px 12px;outline:none}
table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;min-width:940px}
th,td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:left;vertical-align:top}
th{position:sticky;top:0;background:var(--input);z-index:1}
.muted{color:var(--muted)}
.err{color:#f87171;font-weight:700}
</style>
<script src="config.js?v=31"></script>
<script>
(function themeBoot(){
  const saved = localStorage.getItem('tp_theme');
  if(saved) document.documentElement.setAttribute('data-theme', saved);
})();
</script>
</head>
<body>
<header>
  <div class="hgrid">
    <div class="left"><a class="btnLink" href="home.html">← Back</a></div>
    <div class="center"><div class="brand">Training Admin</div></div>
    <div class="right">
      <button id="themeBtn" class="toggle">Dark</button>
      <button id="logoutBtn" class="btn" style="display:none">Log out</button>
      <img src="CX%20Advanced%20Solutions_Smaller_white.png" alt="Logo" style="height:36px;margin-left:8px">
    </div>
  </div>
</header>

<main>
  <!-- Gate -->
  <section id="gate" class="card">
    <div class="row" style="justify-content:center">
      <label class="muted">Admin password</label>
      <input id="adminPass" type="password" placeholder="Enter admin password">
      <button id="adminBtn" class="btn">Sign in</button>
    </div>
    <div id="gateErr" class="err" style="text-align:center;margin-top:8px"></div>
  </section>

  <!-- Customers -->
  <section id="customers" class="card" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="addCompanyBtn" class="btn">Add company</button>
        <button id="refreshCustomersBtn" class="btn secondary">Refresh</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>Company</th><th>Agent code</th><th>Supervisor code</th><th>Admin code</th><th>Active</th><th>Created</th>
        </tr></thead>
        <tbody id="custBody"><tr><td colspan="6" class="muted" style="padding:18px">No companies yet.</td></tr></tbody>
      </table>
    </div>
  </section>

  <!-- Logs -->
  <section id="logs" class="card" style="display:none;margin-top:18px">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <span class="muted">Rows: <strong id="rowCount">0</strong></span>
        <select id="typeFilter"><option value="">All types</option><option value="signin">signin</option><option value="completion">completion</option></select>
        <input id="courseFilter" placeholder="Course (e.g., agent)">
        <input id="search" placeholder="Search name/company">
        <button id="refresh" class="btn secondary">Refresh</button>
      </div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>time (EST)</th><th>Type</th><th>User</th><th>Course</th><th>Company</th><th>Video’s Completed</th>
        </tr></thead>
        <tbody id="tbody"><tr><td colspan="6" class="muted" style="padding:18px">No rows.</td></tr></tbody>
      </table>
    </div>
  </section>
</main>

<script>
const cfg = window.APP_CONFIG;
document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = document.documentElement.getAttribute('data-theme') || 'dark';
  const nxt = cur==='dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', nxt);
  localStorage.setItem('tp_theme', nxt);
  document.getElementById('themeBtn').textContent = nxt==='dark'?'Dark':'Light';
});
document.getElementById('themeBtn').textContent =
  (document.documentElement.getAttribute('data-theme')||'dark')==='dark'?'Dark':'Light';

// Gate (always ask)
const gate = document.getElementById('gate');
const customers = document.getElementById('customers');
const logs = document.getElementById('logs');
const gateErr = document.getElementById('gateErr');
const logoutBtn = document.getElementById('logoutBtn');

function showApp(){
  gate.style.display='none'; customers.style.display=''; logs.style.display='';
  logoutBtn.style.display='';
  loadCustomers(); loadLogs();
}
function showGate(){
  gate.style.display=''; customers.style.display='none'; logs.style.display='none';
  logoutBtn.style.display='none';
}
document.getElementById('adminBtn').addEventListener('click', ()=>{
  gateErr.textContent = '';
  const val = document.getElementById('adminPass').value;
  if(val === cfg.ADMIN_PASS) showApp();
  else gateErr.textContent = 'Incorrect password.';
});
logoutBtn.addEventListener('click', ()=>{ showGate(); });

/* Customers */
const custBody = document.getElementById('custBody');
document.getElementById('refreshCustomersBtn').addEventListener('click', loadCustomers);
document.getElementById('addCompanyBtn').addEventListener('click', async ()=>{
  const name = prompt('Company name'); if(!name) return;
  try{
    const res = await fetch(cfg.SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ mode:'addCompany', token: cfg.ADMIN_TOKEN, company: name }) });
    const text = await res.text(); let data; try{ data = JSON.parse(text);}catch{ data=null; }
    if(!res.ok || !data || data.ok!==true){
      alert((text==='UNAUTHORIZED') ? 'Unauthorized (check ADMIN_TOKEN vs SECRET_TOKEN and redeploy)' : 'Server error: '+text);
      return;
    }
    await loadCustomers();
    alert(`Codes for "${data.company}":\nAgent: ${data.agent}\nSupervisor: ${data.supervisor}\nAdmin: ${data.admin}`);
  }catch(e){ alert('Network error: '+(e?.message||'')); }
});
async function loadCustomers(){
  custBody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>`;
  try{
    const res = await fetch(`${cfg.SCRIPT_URL}?mode=customers&token=${encodeURIComponent(cfg.ADMIN_TOKEN)}`);
    const text = await res.text();
    if(!res.ok){ custBody.innerHTML = `<tr><td colspan="6" class="err" style="padding:18px">HTTP ${res.status}<br><code>${text.slice(0,200)}</code></td></tr>`; return; }
    if(text==='UNAUTHORIZED'){ custBody.innerHTML = `<tr><td colspan="6" class="err" style="padding:18px">UNAUTHORIZED — token mismatch.</td></tr>`; return; }
    const data = JSON.parse(text); const rows = data?.rows||[];
    if(!rows.length){ custBody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px">No companies yet.</td></tr>`; return; }
    custBody.innerHTML = rows.map(r=>`
      <tr>
        <td>${r.company||''}</td>
        <td><code>${r.agent_code||''}</code></td>
        <td><code>${r.supervisor_code||''}</code></td>
        <td><code>${r.admin_code||''}</code></td>
        <td>${String(r.active).toLowerCase()!=='false'?'Yes':'No'}</td>
        <td>${r.created_ts||''}</td>
      </tr>`).join('');
  }catch(e){
    custBody.innerHTML = `<tr><td colspan="6" class="err" style="padding:18px">Network error while loading customers. ${e?.message||''}</td></tr>`;
  }
}

/* Logs */
const tbody = document.getElementById('tbody'), rowCount = document.getElementById('rowCount');
const typeFilter = document.getElementById('typeFilter'), courseFilter = document.getElementById('courseFilter'), search = document.getElementById('search');
document.getElementById('refresh').addEventListener('click', loadLogs);
let allRows = [];
function fmtEST(iso){
  try{
    return new Date(iso).toLocaleString('en-US', {
      timeZone: cfg.TIMEZONE||'America/New_York',
      year:'2-digit', month:'numeric', day:'numeric', hour:'numeric', minute:'2-digit', hour12:true
    }) + ' EST';
  }catch{ return iso||''; }
}
function videosPretty(v){
  if(!v) return '';
  try{
    const arr = typeof v==='string'? JSON.parse(v) : v;
    if(!Array.isArray(arr) || !arr.length) return '';
    return arr.map(x=> x.title || `#${x.index+1}`).join(', ');
  }catch{ return String(v); }
}
async function loadLogs(){
  tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px">Loading…</td></tr>`;
  try{
    const res = await fetch(`${cfg.SCRIPT_URL}?mode=json&token=${encodeURIComponent(cfg.ADMIN_TOKEN)}&limit=2000`);
    const text = await res.text();
    if(!res.ok){ tbody.innerHTML = `<tr><td colspan="6" class="err" style="padding:18px">HTTP ${res.status}<br><code>${text.slice(0,200)}</code></td></tr>`; return; }
    if(text==='UNAUTHORIZED'){ tbody.innerHTML = `<tr><td colspan="6" class="err" style="padding:18px">UNAUTHORIZED — token mismatch.</td></tr>`; return; }
    const data = JSON.parse(text); allRows = data?.rows||[];
    renderLogs();
  }catch(e){ tbody.innerHTML = `<tr><td colspan="6" class="err" style="padding:18px">Failed to load logs.</td></tr>`; }
}
function renderLogs(){
  const t = s => (s==null||s==="")?"":String(s);
  const q = search.value.trim().toLowerCase(), tf = typeFilter.value.trim().toLowerCase(), cf = courseFilter.value.trim().toLowerCase();
  const rows = allRows
    .slice()
    .sort((a,b)=> String(b.ts_server).localeCompare(String(a.ts_server)))
    .filter(r=>{
      const okType = !tf || t(r.type).toLowerCase()===tf;
      const okCourse = !cf || t(r.course).toLowerCase().includes(cf);
      const text = (t(r.name)+" "+t(r.company)).toLowerCase();
      return okType && okCourse && (!q || text.includes(q));
    });
  rowCount.textContent = String(rows.length);
  if(!rows.length){ tbody.innerHTML = `<tr><td colspan="6" class="muted" style="padding:18px">No rows.</td></tr>`; return; }
  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td>${fmtEST(r.ts_server)}</td>
      <td>${r.type||''}</td>
      <td>${r.name||''}</td>
      <td>${r.course||''}</td>
      <td>${r.company||''}</td>
      <td>${videosPretty(r.videos_json)}</td>
    </tr>`).join('');
}
typeFilter.addEventListener('change', renderLogs);
courseFilter.addEventListener('input', renderLogs);
search.addEventListener('input', renderLogs);
</script>
</body>
</html>
